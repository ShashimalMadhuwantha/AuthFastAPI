<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devices Dashboard - SenseGrid</title>
    <meta name="description" content="Real-time IoT device and sensor monitoring dashboard">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/devices.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { "50": "#eff6ff", "100": "#dbeafe", "200": "#bfdbfe", "300": "#93c5fd", "400": "#60a5fa", "500": "#3b82f6", "600": "#2563eb", "700": "#1d4ed8", "800": "#1e40af", "900": "#1e3a8a", "950": "#172554" }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'ui-sans-serif', 'system-ui'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .gradient-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 antialiased">
    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 dark:bg-gray-800 dark:border-gray-700">
        <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
            <a href="dashboard.html" class="flex items-center space-x-3">
                <img src="https://flowbite.s3.amazonaws.com/blocks/marketing-ui/logo.svg" class="h-8"
                    alt="SenseGrid Logo">
                <span class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white">SenseGrid</span>
            </a>
            <div class="flex items-center space-x-4">
                <a href="dashboard.html"
                    class="text-sm text-gray-700 dark:text-gray-300 hover:text-primary-600 dark:hover:text-primary-400 font-medium transition-colors">
                    Dashboard
                </a>
                <a href="users-dashboard.html"
                    class="text-sm text-gray-700 dark:text-gray-300 hover:text-primary-600 dark:hover:text-primary-400 font-medium transition-colors">
                    Users
                </a>
                <a href="devices-dashboard.html" class="text-sm text-primary-600 dark:text-primary-400 font-semibold">
                    Devices
                </a>
                <a href="mqtt-dashboard.html"
                    class="text-sm text-gray-700 dark:text-gray-300 hover:text-primary-600 dark:hover:text-primary-400 font-medium transition-colors">
                    MQTT Dashboard
                </a>
                <span class="text-sm text-gray-700 dark:text-gray-300">Welcome, <span id="usernameDisplay"
                        class="font-semibold"></span></span>
                <button onclick="handleLogout()"
                    class="text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-4 py-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-800">
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main>
        <!-- Header Section -->
        <div class="gradient-header rounded-lg p-8 mb-6 text-white fade-in"
            style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1 class="text-3xl font-bold mb-2">IoT Devices Dashboard</h1>
                <p class="text-lg opacity-90">Real-time monitoring of your IoT devices and sensors</p>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <!-- Settings Icon -->
                <button id="settingsBtn" onclick="openSettingsModal()"
                    style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s;"
                    onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                    onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M12 1v6m0 6v6m8.66-10.5l-5.2 3M8.54 14l-5.2 3m13.32 0l-5.2-3M8.54 10l-5.2-3"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div
                style="background: white; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <!-- Modal Header -->
                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e5e7eb;">
                    <h2 style="font-size: 20px; font-weight: 600; color: #111827;">Settings</h2>
                    <button onclick="closeSettingsModal()"
                        style="background: none; border: none; cursor: pointer; font-size: 24px; color: #6b7280; line-height: 1;">
                        Ã—
                    </button>
                </div>

                <!-- Tabs -->
                <div style="display: flex; border-bottom: 1px solid #e5e7eb;">
                    <button id="realtimeTab" onclick="switchTab('realtime')"
                        style="flex: 1; padding: 16px; background: #047857; color: white; border: none; cursor: pointer; font-weight: 500; border-radius: 0;">
                        Realtime
                    </button>
                    <button id="historyTab" onclick="switchTab('history')"
                        style="flex: 1; padding: 16px; background: #e5e7eb; color: #6b7280; border: none; cursor: pointer; font-weight: 500; border-radius: 0;">
                        History
                    </button>
                </div>

                <!-- Realtime Tab Content -->
                <div id="realtimeContent" style="padding: 24px;">
                    <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin-bottom: 16px;">Auto-Refresh
                        Interval</h3>
                    <p style="font-size: 14px; color: #6b7280; margin-bottom: 20px;">Set how often the dashboard updates
                        with new data</p>

                    <select id="refreshInterval" onchange="updateRefreshInterval()"
                        style="width: 100%; padding: 12px; border: 2px solid #047857; border-radius: 8px; font-size: 14px; cursor: pointer; background: white;">
                        <option value="1">1 second</option>
                        <option value="5" selected>5 seconds</option>
                        <option value="10">10 seconds</option>
                        <option value="15">15 seconds</option>
                        <option value="30">30 seconds</option>
                        <option value="60">1 minute</option>
                        <option value="300">5 minutes</option>
                    </select>

                    <div
                        style="margin-top: 20px; padding: 12px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #047857;">
                        <p style="font-size: 13px; color: #047857; margin: 0;">
                            <strong>Current:</strong> <span id="currentRefreshDisplay">5 seconds</span>
                        </p>
                    </div>
                </div>

                <!-- History Tab Content -->
                <div id="historyContent" style="display: none; padding: 24px;">
                    <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin-bottom: 16px;">Custom Time
                        Range</h3>
                    <p style="font-size: 14px; color: #6b7280; margin-bottom: 20px;">Select start and end date/time for
                        historical data</p>

                    <div style="margin-bottom: 16px;">
                        <label
                            style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Start
                            Date & Time</label>
                        <input type="datetime-local" id="startDateTime"
                            style="width: 100%; padding: 12px; border: 2px solid #047857; border-radius: 8px; font-size: 14px; background: white;">
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label
                            style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">End
                            Date & Time</label>
                        <input type="datetime-local" id="endDateTime"
                            style="width: 100%; padding: 12px; border: 2px solid #047857; border-radius: 8px; font-size: 14px; background: white;">
                    </div>

                    <button onclick="applyCustomDateRange()"
                        style="width: 100%; padding: 12px; background: #047857; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background 0.2s;"
                        onmouseover="this.style.background='#065f46'" onmouseout="this.style.background='#047857'">
                        Apply Date Range
                    </button>

                    <div
                        style="margin-top: 20px; padding: 12px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #047857;">
                        <p style="font-size: 13px; color: #047857; margin: 0;">
                            <strong>Current Range:</strong> <span id="currentPeriodDisplay">Last 24 hours</span>
                        </p>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div
                    style="padding: 20px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 10px;">
                    <button onclick="closeSettingsModal()"
                        style="padding: 10px 20px; background: #047857; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                        Done
                    </button>
                </div>
            </div>
        </div>


        <!-- Devices Container -->
        <div id="devices-container" class="devices-container">
            <div class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
                <p class="mt-2 text-gray-600 dark:text-gray-400">Loading devices...</p>
            </div>
        </div>
    </main>

    <script src="config.js"></script>
    <script>
        // Settings Modal Functions
        function openSettingsModal() {
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function switchTab(tab) {
            const realtimeTab = document.getElementById('realtimeTab');
            const historyTab = document.getElementById('historyTab');
            const realtimeContent = document.getElementById('realtimeContent');
            const historyContent = document.getElementById('historyContent');

            if (tab === 'realtime') {
                realtimeTab.style.background = '#047857';
                realtimeTab.style.color = 'white';
                historyTab.style.background = '#e5e7eb';
                historyTab.style.color = '#6b7280';
                realtimeContent.style.display = 'block';
                historyContent.style.display = 'none';
            } else {
                historyTab.style.background = '#047857';
                historyTab.style.color = 'white';
                realtimeTab.style.background = '#e5e7eb';
                realtimeTab.style.color = '#6b7280';
                historyContent.style.display = 'block';
                realtimeContent.style.display = 'none';
            }
        }

        function updateRefreshInterval() {
            const interval = document.getElementById('refreshInterval').value;
            const displayText = document.getElementById('refreshInterval').options[document.getElementById('refreshInterval').selectedIndex].text;
            document.getElementById('currentRefreshDisplay').textContent = displayText;

            // Store in localStorage
            localStorage.setItem('refreshInterval', interval);

            // Trigger event for devices-app.js to update
            window.dispatchEvent(new CustomEvent('refreshIntervalChanged', { detail: { interval: parseInt(interval) } }));

            console.log('Refresh interval updated to:', interval, 'seconds');
        }

        function applyCustomDateRange() {
            const startDate = document.getElementById('startDateTime').value;
            const endDate = document.getElementById('endDateTime').value;

            if (!startDate || !endDate) {
                alert('Please select both start and end date/time');
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);

            if (start >= end) {
                alert('Start date must be before end date');
                return;
            }

            // Store in localStorage
            localStorage.setItem('customStartDate', startDate);
            localStorage.setItem('customEndDate', endDate);

            // Update display
            const displayText = `${start.toLocaleString()} - ${end.toLocaleString()}`;
            document.getElementById('currentPeriodDisplay').textContent = displayText;

            // Trigger event for devices-app.js to update
            window.dispatchEvent(new CustomEvent('dateRangeChanged', {
                detail: {
                    startDate: startDate,
                    endDate: endDate
                }
            }));

            console.log('Date range updated:', startDate, 'to', endDate);
        }

        // Close modal when clicking outside
        document.addEventListener('click', function (event) {
            const modal = document.getElementById('settingsModal');
            if (event.target === modal) {
                closeSettingsModal();
            }
        });

        // Load saved settings on page load
        window.addEventListener('DOMContentLoaded', function () {
            const savedRefresh = localStorage.getItem('refreshInterval');
            const savedStartDate = localStorage.getItem('customStartDate');
            const savedEndDate = localStorage.getItem('customEndDate');

            if (savedRefresh) {
                document.getElementById('refreshInterval').value = savedRefresh;
                const displayText = document.getElementById('refreshInterval').options[document.getElementById('refreshInterval').selectedIndex].text;
                document.getElementById('currentRefreshDisplay').textContent = displayText;
            }

            // Set default dates (last 24 hours)
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);

            const defaultStart = savedStartDate || yesterday.toISOString().slice(0, 16);
            const defaultEnd = savedEndDate || now.toISOString().slice(0, 16);

            document.getElementById('startDateTime').value = defaultStart;
            document.getElementById('endDateTime').value = defaultEnd;

            if (savedStartDate && savedEndDate) {
                const start = new Date(savedStartDate);
                const end = new Date(savedEndDate);
                const displayText = `${start.toLocaleString()} - ${end.toLocaleString()}`;
                document.getElementById('currentPeriodDisplay').textContent = displayText;

                // Trigger event so devices-app.js knows about the saved range
                // Use setTimeout to ensure devices-app.js has initialized its listeners
                setTimeout(() => {
                    window.dispatchEvent(new CustomEvent('dateRangeChanged', {
                        detail: {
                            startDate: savedStartDate,
                            endDate: savedEndDate
                        }
                    }));
                }, 100);
            }
        });

        // Check if user is logged in
        function checkAuth() {
            const token = localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
            const username = localStorage.getItem('username') || sessionStorage.getItem('username');

            if (!token || !username) {
                window.location.href = 'index.html';
                return null;
            }

            document.getElementById('usernameDisplay').textContent = username;
            return { token, username };
        }

        // Handle logout
        function handleLogout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('username');
            sessionStorage.removeItem('access_token');
            sessionStorage.removeItem('username');
            window.location.href = 'index.html';
        }

        // Initialize
        checkAuth();
    </script>

    <!-- Application Scripts (ES6 Modules) -->
    <script type="module" src="js/devices-app.js"></script>
</body>

</html>